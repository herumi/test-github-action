name: Native ARM64 Windows Build and Test

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build-native-arm64-windows:
    runs-on: windows-11-arm

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Display system information
      run: |
        echo "=== System Information ==="
        systeminfo | findstr /B /C:"OS Name" /C:"OS Version" /C:"System Type"
        echo "Processor: %PROCESSOR_ARCHITECTURE%"
        echo "Processor Identifier: %PROCESSOR_IDENTIFIER%"
        wmic cpu get name
      shell: cmd

    - name: Setup development environment
      run: |
        echo "=== Available Compilers ==="
        where cl 2>nul && cl 2>&1 | findstr "Version" || echo "cl.exe not found"
        where clang++ 2>nul && clang++ --version || echo "clang++ not found"
        where g++ 2>nul && g++ --version || echo "g++ not found"
      shell: cmd

    - name: Install Visual Studio Build Tools for ARM64
      run: |
        Write-Host "=== Installing Visual Studio Build Tools for ARM64 ==="
        
        # Chocolateyを使用してVisual Studio Build Toolsをインストール
        Write-Host "Installing Visual Studio 2022 Build Tools..."
        choco install visualstudio2022buildtools -y
        
        # ARM64用のC++ビルドツールをインストール
        Write-Host "Installing ARM64 C++ build tools..."
        choco install visualstudio2022-workload-vctools -y
        
        # インストール完了を待つ
        Start-Sleep -Seconds 30
        
        # 環境変数を更新
        $vcvarsPath = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\2022\BuildTools\VC\Auxiliary\Build\vcvars64.bat"
        if (Test-Path $vcvarsPath) {
          Write-Host "Setting up VC environment variables..."
          cmd /c "`"$vcvarsPath`" && set" | ForEach-Object {
            if ($_ -match "^(.*?)=(.*)$") {
              $name = $matches[1]
              $value = $matches[2]
              [Environment]::SetEnvironmentVariable($name, $value, "Process")
            }
          }
        }
      shell: powershell

    - name: Install Clang/LLVM (if needed)
      run: |
        if (!(Get-Command clang++ -ErrorAction SilentlyContinue)) {
          Write-Host "Installing LLVM/Clang..."
          choco install llvm -y
          $env:PATH = "C:\Program Files\LLVM\bin;$env:PATH"
          echo "C:\Program Files\LLVM\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        } else {
          Write-Host "Clang++ already available"
        }
      shell: powershell

    - name: Display source code
      run: |
        echo "=== Generated C++ Source Code ==="
        type hello.cpp
      shell: cmd

    - name: Show preprocessor output
      run: |
        echo "=== Preprocessor Output ==="
        if (Get-Command clang++ -ErrorAction SilentlyContinue) {
          Write-Host "Clang++ preprocessor output:"
          clang++ -E -dM hello.cpp | findstr -i "arm\|aarch\|win\|msc"
        }
        if (Get-Command cl -ErrorAction SilentlyContinue) {
          Write-Host "MSVC preprocessor output:"
          cl /E /P hello.cpp | findstr -i "arm\|aarch\|win\|msc"
        }
      shell: powershell
      continue-on-error: true

    - name: Compile with Visual Studio (if available)
      run: |
        # ARM64用のVisual Studio Build Toolsを使用
        Write-Host "=== Compiling with MSVC for ARM64 ==="
        
        # ARM64用のvcvarsを設定
        $vcvarsPath = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\2022\BuildTools\VC\Auxiliary\Build\vcvars64.bat"
        if (Test-Path $vcvarsPath) {
          Write-Host "Setting up ARM64 VC environment..."
          cmd /c "`"$vcvarsPath`" && cl /EHsc /std:c++17 /O2 /MACHINE:ARM64 hello.cpp /Fe:hello_msvc.exe"
          if ($LASTEXITCODE -eq 0) {
            Write-Host "MSVC ARM64 compilation successful"
          } else {
            Write-Host "MSVC ARM64 compilation failed"
          }
        } else {
          Write-Host "ARM64 VC environment not found"
        }
      shell: powershell
      continue-on-error: true

    - name: Compile with Clang++ (if available)
      run: |
        # ARM64用のClang++を使用
        if (Get-Command clang++ -ErrorAction SilentlyContinue) {
          Write-Host "=== Compiling with Clang++ for ARM64 ==="
          # ARM64ターゲットを明示的に指定
          clang++ -std=c++17 -O2 -target aarch64-pc-windows-msvc -o hello_clang.exe hello.cpp
          if ($LASTEXITCODE -eq 0) {
            Write-Host "Clang++ ARM64 compilation successful"
          } else {
            Write-Host "Clang++ ARM64 compilation failed"
          }
        } else {
          Write-Host "Clang++ not available"
        }
      shell: powershell
      continue-on-error: true

    - name: Execute compiled binaries
      run: |
        echo "=== Execution Results ==="

        if (Test-Path "hello_msvc.exe") {
          Write-Host "--- MSVC Binary Output ---"
          .\hello_msvc.exe
          Write-Host ""
        }

        if (Test-Path "hello_clang.exe") {
          Write-Host "--- Clang Binary Output ---"
          .\hello_clang.exe
          Write-Host ""
        }
      shell: powershell


